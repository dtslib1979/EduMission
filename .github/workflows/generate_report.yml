name: Generate Reports
on:
  push:
    paths: ["raw/*.csv"]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    
permissions:
  contents: write
  actions: read
    
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Generate Reports
        run: |
          echo "ğŸ“Š Generating reports from raw data..."
          
          # Create Node.js script to process data
          cat > process_data.js << 'EOF'
          const fs = require('fs');
          
          function parseCSV(content) {
            const lines = content.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).filter(line => line.trim()).map(line => {
              const values = line.split(',');
              const obj = {};
              headers.forEach((header, i) => {
                obj[header] = values[i] ? values[i].trim() : '';
              });
              return obj;
            });
          }
          
          function generatePivots() {
            const population = parseCSV(fs.readFileSync('raw/population.csv', 'utf8'));
            const quota = parseCSV(fs.readFileSync('raw/quota.csv', 'utf8'));
            const cutline = parseCSV(fs.readFileSync('raw/cutline.csv', 'utf8'));
            
            // Generate trends summary
            const pivots = [];
            pivots.push('year,metric,value');
            
            population.forEach(p => {
              pivots.push(`${p.year},population,${p.cohort18}`);
            });
            
            // Aggregate quota by year
            const quotaByYear = {};
            quota.forEach(q => {
              const year = q.year;
              quotaByYear[year] = (quotaByYear[year] || 0) + parseInt(q.quota || 0);
            });
            
            Object.entries(quotaByYear).forEach(([year, total]) => {
              pivots.push(`${year},quota_total,${total}`);
            });
            
            // Calculate median cutline by year
            const cutlineByYear = {};
            cutline.forEach(c => {
              const year = c.year;
              if (!cutlineByYear[year]) cutlineByYear[year] = [];
              cutlineByYear[year].push(parseFloat(c.cut_pct || 0));
            });
            
            Object.entries(cutlineByYear).forEach(([year, cuts]) => {
              cuts.sort((a, b) => a - b);
              const median = cuts[Math.floor(cuts.length / 2)] || 0;
              pivots.push(`${year},cut_pct_median,${median.toFixed(2)}`);
            });
            
            return pivots.join('\n');
          }
          
          function generateSummary() {
            const now = new Date().toISOString();
            const population = parseCSV(fs.readFileSync('raw/population.csv', 'utf8'));
            const quota = parseCSV(fs.readFileSync('raw/quota.csv', 'utf8'));
            
            const totalQuota = quota.reduce((sum, q) => sum + parseInt(q.quota || 0), 0);
            const latestYear = Math.max(...population.map(p => parseInt(p.year)));
            const latestPopulation = population.find(p => parseInt(p.year) === latestYear)?.cohort18 || 0;
            
            return JSON.stringify({
              generated_at: now,
              latest_year: latestYear,
              latest_population: parseInt(latestPopulation),
              total_quota: totalQuota,
              data_files: ['population.csv', 'quota.csv', 'cutline.csv', 'cost.csv'],
              notes: 'ì—”ì§„ ì‹¤í–‰ ì‹œ ìµœì‹  ê°’ìœ¼ë¡œ ì €ì¥',
              trigger: 'GitHub Actions automation'
            }, null, 2);
          }
          
          function generateReport() {
            const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const population = parseCSV(fs.readFileSync('raw/population.csv', 'utf8'));
            const quota = parseCSV(fs.readFileSync('raw/quota.csv', 'utf8'));
            const cutline = parseCSV(fs.readFileSync('raw/cutline.csv', 'utf8'));
            
            const years = [...new Set(population.map(p => parseInt(p.year)))].sort();
            const latestYear = Math.max(...years);
            const prevYear = latestYear - 1;
            
            const currentPop = population.find(p => parseInt(p.year) === latestYear)?.cohort18 || 0;
            const prevPop = population.find(p => parseInt(p.year) === prevYear)?.cohort18 || 0;
            const popChange = prevPop ? ((currentPop - prevPop) / prevPop * 100).toFixed(2) : 'N/A';
            
            const totalQuota = quota.reduce((sum, q) => sum + parseInt(q.quota || 0), 0);
            const avgCutline = cutline.length ? 
              (cutline.reduce((sum, c) => sum + parseFloat(c.cut_pct || 0), 0) / cutline.length).toFixed(2) : 'N/A';
            
            return `# EduMission ìë™ ìƒì„± ë¦¬í¬íŠ¸

**ìƒì„± ì¼ì‹œ:** ${now}

## ğŸ“Š ë°ì´í„° ìš”ì•½

### ì¸êµ¬ ë™í–¥
- ìµœì‹  ì—°ë„: ${latestYear}ë…„
- í˜„ì¬ 18ì„¸ ì¸êµ¬: ${parseInt(currentPop).toLocaleString()}ëª…
- ì „ë…„ ëŒ€ë¹„ ì¦ê°ë¥ : ${popChange}%

### ëŒ€í•™ ì…ì‹œ í˜„í™©
- ì´ ëª¨ì§‘ì •ì›: ${totalQuota.toLocaleString()}ëª…
- í‰ê·  ì»¤íŠ¸ë¼ì¸: ${avgCutline} ë°±ë¶„ìœ„
- ë°ì´í„° ê¸°ì¤€ ì—°ë„: ${Math.min(...years)}~${Math.max(...years)}

### ë¶„ì„ ëŒ€ìƒ
- ëŒ€í•™ ìˆ˜: ${new Set(quota.map(q => q.univ)).size}ê°œ
- í•™ê³¼ ìˆ˜: ${new Set(quota.map(q => q.dept)).size}ê°œ
- ì „í˜• ìœ í˜•: ${new Set(quota.map(q => q.scheme)).size}ê°œ

## ğŸ”„ ìë™í™” ìƒíƒœ

âœ… **ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì •ìƒ ì‘ë™**
- íŠ¸ë¦¬ê±°: raw/*.csv íŒŒì¼ ë³€ê²½ ê°ì§€
- ì‹¤í–‰ ì‹œê°: ${now}
- ì²˜ë¦¬ëœ ë°ì´í„°: 2024-2026 ì¸êµ¬ ë™í–¥

---

*ì´ ë¦¬í¬íŠ¸ëŠ” raw/*.csv íŒŒì¼ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.*`;
          }
          
          // Generate all outputs
          try {
            console.log('ğŸ“ Reading input files...');
            console.log('  - raw/population.csv');
            console.log('  - raw/quota.csv');  
            console.log('  - raw/cutline.csv');
            
            fs.writeFileSync('outputs/pivots.csv', generatePivots());
            fs.writeFileSync('outputs/summary.json', generateSummary());
            fs.writeFileSync('outputs/report.md', generateReport());
            
            console.log('âœ… Reports generated successfully!');
            console.log('ğŸ“ Generated files:');
            console.log('  - outputs/pivots.csv');
            console.log('  - outputs/summary.json');
            console.log('  - outputs/report.md');
          } catch (error) {
            console.error('âŒ Error generating reports:', error);
            process.exit(1);
          }
          EOF
          
          # Run the data processing
          node process_data.js
          
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ğŸ” Checking for changes in outputs/..."
          git status outputs/
          
          # Check if there are changes
          if [ -n "$(git status --porcelain outputs/)" ]; then
            echo "ğŸ“ Changes detected, committing..."
            git add outputs/
            git commit -m "auto: update outputs after raw data change"
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸  No changes detected in outputs"
          fi