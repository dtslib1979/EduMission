name: Validate CSV Data
on:
  push:
    paths: ["raw/*.csv"]
  pull_request:
    paths: ["raw/*.csv"]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate CSV Schema and Data
        run: |
          echo "🔍 Validating CSV files..."
          
          # Check population.csv
          if [ -f "raw/population.csv" ]; then
            echo "📊 Checking population.csv"
            head -1 raw/population.csv | grep -q "year,cohort18" || {
              echo "❌ ERROR: population.csv header should be 'year,cohort18'"
              exit 1
            }
            # Check data rows
            tail -n +2 raw/population.csv | while IFS=, read -r year cohort18; do
              if ! [[ "$year" =~ ^[0-9]{4}$ ]] || ! [[ "$cohort18" =~ ^[0-9]+$ ]]; then
                echo "❌ ERROR: Invalid data in population.csv: $year,$cohort18"
                exit 1
              fi
            done
            echo "✅ population.csv valid"
          fi
          
          # Check quota.csv
          if [ -f "raw/quota.csv" ]; then
            echo "📊 Checking quota.csv"
            head -1 raw/quota.csv | grep -q "year,univ,dept,scheme,quota" || {
              echo "❌ ERROR: quota.csv header should be 'year,univ,dept,scheme,quota'"
              exit 1
            }
            echo "✅ quota.csv valid"
          fi
          
          # Check cutline.csv
          if [ -f "raw/cutline.csv" ]; then
            echo "📊 Checking cutline.csv"
            head -1 raw/cutline.csv | grep -q "year,univ,dept,scheme,cut_pct,cut_std" || {
              echo "❌ ERROR: cutline.csv header should be 'year,univ,dept,scheme,cut_pct,cut_std'"
              exit 1
            }
            echo "✅ cutline.csv valid"
          fi
          
          # Check cost.csv
          if [ -f "raw/cost.csv" ]; then
            echo "📊 Checking cost.csv"
            head -1 raw/cost.csv | grep -q "year,univ,tuition_year,scholarship_rate,commute_min" || {
              echo "❌ ERROR: cost.csv header should be 'year,univ,tuition_year,scholarship_rate,commute_min'"
              exit 1
            }
            echo "✅ cost.csv valid"
          fi
          
          echo "🎉 All CSV files validated successfully!"