name: Validate CSV Data
on:
  push:
    paths: ["raw/*.csv"]
  pull_request:
    paths: ["raw/*.csv"]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate CSV Schema and Data
        run: |
          echo "ğŸ” Validating CSV files..."
          
          # Check population.csv
          if [ -f "raw/population.csv" ]; then
            echo "ğŸ“Š Checking population.csv"
            head -1 raw/population.csv | grep -q "year,cohort18" || {
              echo "âŒ ERROR: population.csv header should be 'year,cohort18'"
              exit 1
            }
            # Check data rows
            tail -n +2 raw/population.csv | while IFS=, read -r year cohort18; do
              if ! [[ "$year" =~ ^[0-9]{4}$ ]] || ! [[ "$cohort18" =~ ^[0-9]+$ ]]; then
                echo "âŒ ERROR: Invalid data in population.csv: $year,$cohort18"
                exit 1
              fi
            done
            echo "âœ… population.csv valid"
          fi
          
          # Check quota.csv
          if [ -f "raw/quota.csv" ]; then
            echo "ğŸ“Š Checking quota.csv"
            head -1 raw/quota.csv | grep -q "year,univ,dept,scheme,quota" || {
              echo "âŒ ERROR: quota.csv header should be 'year,univ,dept,scheme,quota'"
              exit 1
            }
            echo "âœ… quota.csv valid"
          fi
          
          # Check cutline.csv
          if [ -f "raw/cutline.csv" ]; then
            echo "ğŸ“Š Checking cutline.csv"
            head -1 raw/cutline.csv | grep -q "year,univ,dept,scheme,cut_pct,cut_std" || {
              echo "âŒ ERROR: cutline.csv header should be 'year,univ,dept,scheme,cut_pct,cut_std'"
              exit 1
            }
            echo "âœ… cutline.csv valid"
          fi
          
          # Check cost.csv
          if [ -f "raw/cost.csv" ]; then
            echo "ğŸ“Š Checking cost.csv"
            head -1 raw/cost.csv | grep -q "year,univ,tuition_year,scholarship_rate,commute_min" || {
              echo "âŒ ERROR: cost.csv header should be 'year,univ,tuition_year,scholarship_rate,commute_min'"
              exit 1
            }
            echo "âœ… cost.csv valid"
          fi
          
          echo "ğŸ‰ All CSV files validated successfully!"